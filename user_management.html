<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>user_management</title>
    <link href="css/bootstrap.css" rel="stylesheet">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/bootstrap-table.css">
    <link rel="stylesheet" href="css/bootstrap-editable.css">
    <link rel="stylesheet" href="css/jquery-ui.css">
    <script src="js/jquery.js"></script>
    <script src="js/jquery.min.js"></script>
    <script src="js/jquery-ui.min.js"></script>
    <script src="js/jquery.ui.touch-punch.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/bootstrap-table.js"></script>
    <script src="js/bootstrap-table-zh-CN.js"></script>
    <script src="js/extensions/editable/bootstrap-table-editable.js"></script>
    <script src="js/bootstrap-editable.js"></script>
    <script src="js/extensions/export/bootstrap-table-export.js"></script>
    <script src="js/tableExport.js"></script>
    <script type="text/javascript" src="js/sheetjs.all.min.js"></script>
    <script type="text/javascript" src="js/excelplus-2.4.1.min.js"></script>
</head>
<body>
<h2>用户管理</h2>
<table class="table table-striped" id="datagrid" data-url="../app/data/url.json" data-show-export="true"></table>
<div id="toolbar" style="display: none">
    <div class="form-group">
        <div class="input-group">
            <label style="font-size: 26px">数据列表</label>
            <button id="btn_add" style="margin-left: 22px" type="button" class="btn btn-primary" data-toggle="modal" data-target="#myModal">
                <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>新增
            </button>
            <label  style="font-size: 20px; margin-left: 20px">导入</label>&nbsp;&nbsp;
            <input id="file-object" type="file" value="Open an Excel file" style="width: 200px;display: inline-block">
            <label  style="font-size: 20px">导出</label>&nbsp&nbsp
            <select style="width: auto;float: right" class="form-control">
                <option value="basic">基本导出</option>
                <option value="all">全部导出</option>
                <option value="selected">选择导出</option>
            </select>
        </div>
    </div>
</div>
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div id="modalDialog" class="modal-dialog" role="document" style="width:500px">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #428bca;">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    ×
                </button>
                <h4 class="modal-title" id="myModalLabel" style="color: #fff">
                    新增监控信息
                </h4>
            </div>
            <div class="modal-body">
                <form role="form" id="modalform" class="form-horizontal">
                    <div class="form-group">
                        <label class="col-sm-3 control-label" style="text-align: center">标题</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" id="title"
                                   placeholder="请输入标题" onclick="$(this).focus()">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3 control-label" style="text-align: center">通知</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" id="memo"
                                   placeholder="请输入通知类型" onclick="$(this).focus()" onblur="$(this).next('input').focus()">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3 control-label" style="text-align: center">得分</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" id="score"
                                   placeholder="请输入得分" onclick="$(this).focus()" onblur="$(this).next('input').focus()">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3 control-label" style="text-align: center">项目编号</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" id="pro_id"
                                   placeholder="请输入项目编号" onclick="$(this).focus()" onblur="$(this).next('input').focus()">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3 control-label" style="text-align: center">调查类型</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" id="typename"
                                   placeholder="请输入调查类型" onclick="$(this).focus()" onblur="$(this).next('input').focus()">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3 control-label" style="text-align: center">用户组</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" id="auser"
                                   placeholder="请输入用户组" onclick="$(this).focus()" onblur="$(this).next('input').focus()">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3 control-label" style="text-align: center">选择学校类型</label>
                        <div class="col-sm-9">
                            <select id="astep" class="form-control" onclick="$(this).focus()" onblur="$(this).next('input').focus()">
                                <option>小学</option>
                                <option>初中</option>
                                <option>高中</option>
                                <option>大学</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3 control-label" style="text-align: center">英语标题</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" id="englishtitle"
                                   placeholder="请输入英语标题" onclick="$(this).focus()" onblur="$(this).next('input').focus()"/>
                        </div>
                    </div>
                    <div class="form-group">
                        <label  class="col-sm-3 control-label" style="text-align: center">选择用户类型</label>
                        <div class="col-sm-9">
                            <select id="usertype" class="form-control" onclick="$(this).focus()" onblur="$(this).next('input').focus()">
                                <option>学生</option>
                                <option>老师</option>
                                <option>行政人员</option>
                                <option>后勤人员</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <button type="button" class="btn btn-default col-sm-offset-1" data-dismiss="modal">关闭
                        </button>
                        <button type="button" id="addRecord" class="btn btn-primary col-sm-offset-1">增加</button>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="mydeleteModal" tabindex="-1" role="dialog" aria-labelledby="mydeleteModalLabel">
    <div class="modal-dialog" role="document" style="margin-top: 18%">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #FCF8E3">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="mydeleteModalLabel">您确定删除选定的记录吗？</h4>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                <button type="button" id="deleteRecord" class="btn btn-primary">确定</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="importSuccessModal" tabindex="-1" role="dialog" aria-labelledby="mydeleteModalLabel">
    <div class="modal-dialog" role="document" style="margin-top: 19%">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #DEF0D8">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="importSuccessModalLabel">导入成功！</h4>
            </div>
            <div class="modal-footer">
                <button type="button" id="importSuccess" class="btn btn-primary">确定</button>
            </div>
        </div>
    </div>
</div>
<script>
    $(function () {
        //如果是移动端访问则固定modal位置，在PC上则可以调整其大小位置
        var sUserAgent = navigator.userAgent.toLowerCase();
        var bIsIpad = sUserAgent.match(/ipad/i) == "ipad";
        var bIsIphoneOs = sUserAgent.match(/iphone os/i) == "iphone os";
        var bIsMidp = sUserAgent.match(/midp/i) == "midp";
        var bIsUc7 = sUserAgent.match(/rv:1.2.3.4/i) == "rv:1.2.3.4";
        var bIsUc = sUserAgent.match(/ucweb/i) == "ucweb";
        var bIsAndroid = sUserAgent.match(/android/i) == "android";
        var bIsCE = sUserAgent.match(/windows ce/i) == "windows ce";
        var bIsWM = sUserAgent.match(/windows mobile/i) == "windows mobile";
        if (bIsIpad || bIsIphoneOs || bIsMidp || bIsUc7 || bIsUc || bIsAndroid || bIsCE || bIsWM) {
            //移动端固定modal位置（能draggable、但是不能resizable）(具体可能js间有冲突?)
//            $('#myModal .modal-content').resizable({
//                minHeight: 610,
//                minWidth: 351
//            });
            $('.modal-dialog').draggable();
            $('#myModal').on('show.bs.modal', function () {
                $(this).find('.modal-body').css({
                    'max-height':'100%'
                });
            });
            $("#myModal").css("overflow", "hidden");//禁止模态对话框的半透明背景滚动
            $("#myModal").on("hide.bs.modal", function () {
                $('#title').val('');
                $('#memo').val('');
                $('#score').val('');
                $('#pro_id').val('');
                $('#typename').val('');
                $('#auser').val('');
                $('#englishtitle').val('');
            });
        } else {
            //pc端不固定modal位置（可以draggable和resizable）
            $('#myModal .modal-content').resizable({
                minHeight: 610,
                minWidth: 351
            });
            $('.modal-dialog').draggable();
            $('#myModal').on('show.bs.modal', function () {
                $(this).find('.modal-body').css({
                    'max-height':'100%'
                });
            });
            $("#myModal").css("overflow", "hidden");//禁止模态对话框的半透明背景滚动
            $("#myModal").on("hide.bs.modal", function () {
                $('#title').val('');
                $('#memo').val('');
                $('#score').val('');
                $('#pro_id').val('');
                $('#typename').val('');
                $('#auser').val('');
                $('#englishtitle').val('');
            });
        }
    });
    $(function () {
        var inialTable = function ($exprotType) {
            var or = [];
            $('#datagrid').bootstrapTable({
                dataType: 'json',
                columns: [{
                    checkbox: true
                },
                    {
                        field: 'ID',
                        title: 'ID',
                        sortable: true
                    },
                    {
                        field: 'TITLE',
                        title: '标题',
                        editable: {
                            type: 'text',
                            validate: function (value) {
                                if ($.trim(value) == '') {
                                    return '测量值不能为空';
                                }
                            }
                        }
                    },
                    {
                        field: 'MEMO',
                        title: '通知',
                        editable: {
                            type: 'text'
                        }
                    }, {
                        field: 'SCORE',
                        title: '得分',
                        editable: {
                            type: 'text',
                            validate: function (value) {
                                if ($.trim(value) == '') {
                                    return '得分不能为空';
                                }
                            }
                        }
                    },
                    {
                        field: 'PRJ_ID',
                        title: '项目编号',
                        editable: {
                            type: 'text',
                            validate: function (value) {
                                if ($.trim(value) == '') {
                                    return '编号不能为空';
                                }
                            }
                        }
                    },
                    {
                        field: 'TYPENAME',
                        title: '调查类型',
                        editable: {
                            type: 'text',
                            validate: function (value) {
                                if ($.trim(value) == '') {
                                    return '类型不能为空';
                                }
                            }
                        }
                    },
                    {
                        field: 'AUSER',
                        title: '用户组',
                        editable: {
                            type: 'text',
                            validate: function (value) {
                                if ($.trim(value) == '') {
                                    return '类型不能为空';
                                }
                            }
                        }
                    },
                    {
                        field: 'ASTEP',
                        title: '学校类型',
                        editable: {
                            type: 'text',
                            validate: function (value) {
                                if ($.trim(value) == '') {
                                    return '学校类型不能为空';
                                }
                            }
                        }
                    },
                    {
                        field: 'ENGLISHTITLE',
                        title: '英语标题',
                        editable: {
                            type: 'text',
                            validate: function (value) {
                                if ($.trim(value) == '') {
                                    return '英语标题不能为空';
                                }
                            }
                        }
                    },
                    {
                        field: 'USERTYPE',
                        title: '用户类型',
                        editable: {
                            type: 'text',
                            validate: function (value) {
                                if ($.trim(value) == '') {
                                    return '用户类型不能为空';
                                }
                            }
                        }
                    },
                    {
                        field: 'OPERATION',
                        title: '操作&nbsp;&nbsp;&nbsp;&nbsp;',
                        formatter: function (value, row, index) {
                            var i = ' ';
                            or.push(JSON.stringify(row));
                            var s = '<a class="save" href="javascript:void(0)" title="Like"><i class="glyphicon glyphicon-ok"></i></a>';
                            var d = '<a class="remove" href="javascript:void(0)" title="Remove"><i class="glyphicon glyphicon-remove" data-toggle="modal" data-target="#mydeleteModal"></i></a>';
                            return  i + s + '&nbsp&nbsp&nbsp&nbsp' + d;

                        },
                        events: 'operateEvents'
                    }],
                sortName: 'ID',
                sortOrder: 'asc',
                pagination: true,
                uniqueId: "ID",
                //显示分页方式（客户端和服务器端分页）
                sidePagination: 'client',
                pageNumber: 1,
                pageSize: 10,
                pageList: [5, 10, 20],
                toolbar: '#toolbar',
                //显示是否显示刷新图标
                showRefresh: 'true',
                //选择是否切换视图图标出现
                showToggle: 'true',
                //选择是否显示出根据field来显示数据
                showColumns: 'true',
                //显示是否出现搜索框
                search: true,
                clickToSelect: true,
                showExport: true,
                exportDataType: $exprotType
            });
            //这里设置table-toolbar样式,必须先设置高度，再设置背景颜色
            $('.fixed-table-toolbar').css("backgroundColor", "#D9EDF6");
            //清除select选择框的左浮动
            var $tb = $('#toolbar');
            var $pl = $('.pull-left');
            var $prs = $('.pull-right.search');
            var $ccbp = $('.columns.columns-right.btn-group.pull-right');
            var $bt = $('.bootstrap-table');
            $tb.find('select').css("float", "right");
            $pl.css("margin-top", "20px");
            $pl.css("margin-bottom", "0px");
            $prs.css("margin-top", "20px");
            $prs.css("margin-bottom", "0px");
            $ccbp.css("margin-top", "20px");
            $ccbp.css("margin-bottom", "0px");
            $tb.css("display", 'block');
            $bt.css("width", "100%");
            $bt.css("border", "1px #D9EDF6 solid");
            $bt.css("float", "right");
            $bt.css("margin-top", "68px");
            window.operateEvents = {
                'click .save': function (e, value, row, index) {
//                       //只传入修改相关字段后的json
                    var oldr = JSON.parse(or[index]);
                    //删除json格式第一个元素属性"0"
                    delete row["0"];
                    var newr = JSON.parse(JSON.stringify(row));
                    var data = {};
                    data["ID"] = newr["ID"];
                    for(var key in newr) {
                        if(newr[key]==oldr[key]){
                            continue;
                        }else {
                            data[key] = newr[key];
                        }
                    }
//                    console.log(data);
//                       var ds = new dataset();
//                       $.ajax({
//                           type: "post",
//                           data: row,
//                           //请求后端保存的url
//                           url: '/Analyze/EditMeterMeasureHistoryData',
//                           success: function (data) {
//                               alert('修改成功');
//                           }
//                       });
                    $("#datagrid").bootstrapTable('updateByUniqueId', {
                        id: row.ID,
                        row: row
                    })
                },
                'click .remove': function (e, value, row, index) {
                    $("#deleteRecord").click(function () {
                        //先进行ajax异步提交后台数据库正确处理返回结果后才进行前台删除操作
                        //$.ajax()
                        $("#mydeleteModal").modal('hide');
                        $('#datagrid').bootstrapTable('removeByUniqueId', row.ID);
                    });
//                       $.ajax({
//                           type: "post",
//                           data: row,
//                           //请求后端删除的url
//                           url: '/Analyze/DeleteMeterMeasureHistoryData',
//                           success: function (data) {
//                               alert('删除成功');
//                               $('#querylist').bootstrapTable('remove', {
//                                   field: 'MeterMeasureHistoryID',
//                                   values: [row.MeterMeasureHistoryID]
//                               });
//                           }
//                       });
//                    $('#datagrid').bootstrapTable('removeByUniqueId', row.ID);
                }
            }
        };
        new inialTable();
        $('#toolbar').find('select').change(function () {
            var $datagrid = $('#datagrid');
            $datagrid.bootstrapTable('destroy');
            new inialTable($(this).val());
        });
    });
    $(function () {
        var ep=new ExcelPlus();
        ep.openLocal({
            "flashPath":"js/swfobject/",
            "labelButton":"Open an Excel file"
        },function() {
            var a = ep.selectSheet(1).readAll();
            var jsondata = "[";
            for (var i=1; i<a.length; i++){
                jsondata += "{";
                for (var j=0; j<a[i].length; j++){
                    if (j == a[i].length-1) {
                        jsondata += "\""+a[0][j] + "\"" + ":" + "\""+ a[i][j] + "\"";
                    } else {
                        jsondata += "\""+a[0][j] + "\"" + ":" + "\""+ a[i][j] + "\"" + ",";
                    }
                }
                if (i == a.length-1){
                    jsondata += "}"
                }else {
                    jsondata += "},"
                }
            }
            jsondata += "]";
            console.log(jsondata);
            //这里先把json格式数据jsondata通过ajax传回到后台，而返回成功信息后再将信息a显示到前台界面
            //$.ajax()
            $("#importSuccessModal").modal('show');
            $("#datagrid").bootstrapTable('append', getExcelData());
            function getExcelData() {
                var excelDatas = [];
                for (var i=1; i<a.length; i++) {
                    var exceldata = {
                        ID: a[i][0],
                        TITLE: a[i][1],
                        MEMO: a[i][2],
                        SCORE: a[i][3],
                        PRJ_ID: a[i][4],
                        TYPENAME: a[i][5],
                        AUSER: a[i][6],
                        ASTEP: a[i][7],
                        ENGLISHTITLE: a[i][8],
                        USERTYPE: a[i][9]
                    };
                    excelDatas.push(exceldata);
                }
                return excelDatas;
            }
        });
    });
    $("#addRecord").click(function () {
        //首先进行ajax异步提交后台数据库当正确返回success时才做出更新数据表的处理
        //$.ajax();
        $("#datagrid").bootstrapTable('append', {
            ID: 18,
            TITLE: $('#title').val(),
            MEMO: $('#memo').val(),
            SCORE: $('#score').val(),
            PRJ_ID: $('#pro_id').val(),
            TYPENAME: $('#typename').val(),
            AUSER: $('#auser').val(),
            ASTEP: $('#astep').val(),
            ENGLISHTITLE: $('#englishtitle').val(),
            USERTYPE: $('#usertype').val()
        });
        $("#myModal").modal('hide');
    });
    $("#importSuccess").click(function () {
        $("#importSuccessModal").modal('hide');
    });
</script>
</body>
</html>